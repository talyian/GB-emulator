<!DOCTYPE html>
<canvas id=tile0 width=128 height=64 style='background:#fed'> </canvas> <!--16 * 8 tiles each at 8*8-->
<canvas id=tile1 width=128 height=64 style='background:#fed'> </canvas> <!--16 * 8 tiles each at 8*8-->
<canvas id=tile2 width=128 height=64 style='background:#fed'> </canvas> <!--16 * 8 tiles each at 8*8-->
<canvas id=bg width=256 height=256 style='background:#def'> </canvas>
<script>
  if (typeof TextDecoder == "undefined") {
    function TextDecoder() {  }
    TextDecoder.prototype.decode = function (arr) {
      return String.fromCharCode.apply(null, new Uint8Array(arr));
    }
  }
  var instance, line=[], dec = new TextDecoder();
  var memory = new WebAssembly.Memory({ initial: 1024 });

  function draw_vram(canvas, data) {
    var ctx = canvas.getContext("2d");
    var w = 8, tile_idx = 0, tile_number = 0,sum = 0;
    // 0x800 bytes, 0x80 sprites, so each one takes up 0x10 bytes
    for(var y = 0; y < 8; y++) {
      for(var x = 0; x < 16; x++) {
        tile_number++;
        for(var j = 0; j < 8; j++) {
          var b0 = data[tile_idx++];
          var b1 = data[tile_idx++];
          var w0 = b0 * 0x100 + b1;
          pp = []
          for(var i = 0; i < 8; i++) {
            var p = (w0 >> (14 - 2 * i)) & 0x3;
            pp.push(p);
            sum += p;
            ctx.fillStyle = ['blue', 'red', 'yellow', 'black'][p];
            ctx.fillRect(x * 8 + i, y * 8 + j, 1, 1);
          }
          if (w0) console.log(w0, pp);
        }
      }
    }
    console.log('sum',sum);
  }
  function push_frame(category, data, len) {
    var buf = new Uint8Array(memory.buffer.slice(data, data + len));
    console.log("frame", len);
    if (category == 0x100) { // tile data
      draw_vram(tile0, buf);
    }
    if (category == 0x101) { // tile data
      draw_vram(tile1, buf);
    }
    if (category == 0x102) { // tile data
      draw_vram(tile2, buf);
    }
    var ctx = bg.getContext("2d");
    if (category == 0x200) { // background
      var w = 8, i = 0, cc = {};
      for(var y = 0; y < 32; y++) {
        for(var x = 0; x < 32; x++) {
          ctx.fillStyle = ['red', 'blue','green', 'pink'][buf[i++] % 4]
          ctx.fillRect(x * w, y * w, w, w);
        }
      }
    }
  }
  
  var env = {
    _test: function(foobar) { console.log(foobar); },
    _logf: function(f) { line.push(f); },
    _logx8: function(f) { line.push(('00' + f.toString(16)).substr(-2)); },
    _logx16: function(f) { line.push(('0000' + f.toString(16)).substr(-4)); },
    _logs: function(i, len) {
      if (!len) { line.push(i.toString(16)); return; }
      line.push(dec.decode(memory.buffer.slice(i, i + len))); },
    _showlog: function() { console.log.apply(console, line); line = []; },
    _push_frame: push_frame,
    memory:memory
  };
  fetch("build/gb_emulator.wasm")
  .then((resp) => resp.arrayBuffer())
  .then((wasm) => WebAssembly.instantiate(wasm, { env: env }))
  .then((module) => {
    instance = module.instance;
    instance.exports.emu_main(); });
</script>
